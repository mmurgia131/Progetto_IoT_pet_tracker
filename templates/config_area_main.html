<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Configurazione Area e Stanze</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
      body {
        background: #f5f7fa;
        font-family: 'Segoe UI', Roboto, sans-serif;
      }
      .container {
        max-width: 1100px;
        margin: 40px auto;
        background: #fff;
        padding: 36px;
        border-radius: 18px;
        box-shadow: 0 2px 18px rgba(0,0,0,0.1);
      }
      h1 {
        font-size: 2rem;
        color: #1a237e;
        margin-bottom: 30px;
        font-weight: 600;
      }
      h3 {
        color: #1e3a8a;
        margin-top: 28px;
        margin-bottom: 10px;
        font-weight: 600;
      }
      hr {
        margin: 28px 0;
        border: none;
        border-top: 1px solid #e0e0e0;
      }

      /* Bottone Torna alla Dashboard */
      .dashboard-btn-container { margin: 16px 0 32px 10px; }
      .dashboard-btn {
        background: #1976d2;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 12px 24px;
        font-size: 1.15rem;
        cursor: pointer;
        font-weight:500;
        display:flex;
        align-items:center;
        gap:8px;
        transition: all 0.2s;
        box-shadow: 0 3px 6px rgba(25,118,210,0.25);
      }
      .dashboard-btn:hover { background: #125a9c; transform: translateY(-1px); }

      /* Mappa e perimetro */
      #map {
        height: 340px;
        border-radius: 14px;
        border: 1.5px solid #b3d4fc;
        margin: 12px 0 18px 0;
        width: 100%;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      }
      .radius-config {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }
      .radius-badge {
        background: #3949ab;
        color: #fff;
        border-radius: 12px;
        padding: 4px 14px;
        font-size: 1rem;
        font-weight: 500;
      }
      .use-gps-btn {
          background: #43a047;
          color: #fff;
          border: none;
          border-radius: 10px;
          padding: 10px 22px;
          font-size: 1.05rem;
          cursor: pointer;
          font-weight: 600;
          transition: all 0.2s;
          box-shadow: 0 3px 6px rgba(67,160,71,0.25);
      }
      .use-gps-btn:hover { background: #2e7d32; transform: translateY(-1px); }

      .btn-ghost {
        background: transparent;
        border: 1.5px solid #1976d2;
        color: #1976d2;
        padding: 8px 14px;
        border-radius: 10px;
        cursor:pointer;
        font-weight: 500;
        transition: all 0.2s;
      }
      .btn-ghost:hover { background:#e3f2fd; }

      /* Tabelle PET e Stanze */
      table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 12px;
      }
      th {
        background: #f3f6fb;
        color: #1976d2;
        text-align: left;
        font-weight: 700;
        padding: 12px 14px;
        border-bottom: 1px solid #e0e0e0;
      }
      td {
        padding: 12px 14px;
        border-bottom: 1px solid #f0f0f0;
      }
      tr:hover { background: #f9fbff; cursor: pointer; }
      .pet-selected { background: #e6f7ea !important; }

      /* Form aggiungi stanza */
      .add-room-form {
        margin-top: 40px;
        display: flex;
        flex-direction: column;
        gap: 14px;
        padding: 20px;
        border-radius: 14px;
        background: #f9fafb;
        box-shadow: inset 0 0 6px rgba(0,0,0,0.05);
      }
      .add-room-form input[type=text] {
        padding: 10px 12px;
        border: 1.5px solid #cfd8dc;
        border-radius: 8px;
        font-size: 1rem;
        transition: border 0.2s;
      }
      .add-room-form input[type=text]:focus {
        border-color: #1976d2;
        outline: none;
      }
      .add-room-form button[type=submit] {
        align-self: flex-start;
        background: #1976d2;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 3px 6px rgba(25,118,210,0.25);
      }
      .add-room-form button[type=submit]:hover {
        background: #125a9c;
        transform: translateY(-1px);
      }

      /* Switch accesso stanza */
      .switch {
        position: relative;
        display: inline-block;
        width: 46px;
        height: 24px;
      }
      .switch input { display:none; }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #ccc;
        transition: .3s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px; width: 18px;
        left: 3px; bottom: 3px;
        background-color: white;
        transition: .3s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #43a047;
      }
      input:checked + .slider:before {
        transform: translateX(22px);
      }

      @media (max-width: 900px) {
        .container { max-width: 95vw; padding: 20px; }
        .radius-config { flex-direction: column; align-items:flex-start; }
      }
  </style>
</head>
<body>

  <!-- Bottone Torna alla Dashboard -->
  <div class="dashboard-btn-container">
      <form method="get" action="{{ url_for('dashboard') }}">
          <button type="submit" class="dashboard-btn">‚Üê Torna alla Dashboard</button>
      </form>
  </div>

  <div class="container">
      <h1>Configurazione Area e Stanze</h1>

            <!-- Mappa e perimetro -->
      <h3>Area consentita</h3>
      <div id="map"></div>

      <form id="perimeter-form" method="post" action="{{ url_for('update_perimeter') }}" class="radius-config">
          <div style="display:flex;align-items:center;gap:10px;">
            <span>Raggio:</span>
            <input type="range" id="radius_slider" name="radius" min="10" max="150" value="{{ perimeter_radius|default(50,true)|int }}">
            <span id="radius_label" class="radius-badge">{{ perimeter_radius|default(50,true)|int }} m</span>
          </div>

          <input type="hidden" name="center_lat" id="center_lat" value="{{ perimeter_center[0]|default(45.123456,true)|float }}">
          <input type="hidden" name="center_lng" id="center_lng" value="{{ perimeter_center[1]|default(9.123456,true)|float }}">

          <div class="btn-row">
            <button type="button" class="use-gps-btn" onclick="setCenterToPetLocation()">Usa posizione attuale del Pet</button>
            <button type="submit" class="btn-ghost">Salva perimetro</button>
          </div>
      </form>


      <!-- Sezione selezione Pet -->
      <h3>Seleziona il Pet</h3>
      <table id="pets-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>MAC</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody>
          {% if pets %}
            {% for pet in pets %}
            <tr data-pet-id="{{ pet._id }}" data-pet-mac="{{ pet.get('mac_address','') }}">
              <td>{{ pet.get('name','Senza nome') }}</td>
              <td>{{ pet.get('mac_address','-') }}</td>
              <td>
                <button type="button" class="btn-ghost" onclick="event.stopPropagation(); selectPetRow(this.closest('tr'))">Seleziona</button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="3">Nessun pet registrato.</td></tr>
          {% endif %}
        </tbody>
      </table>

      <!-- Form aggiungi stanza -->
      <form class="add-room-form" method="post" action="{{ url_for('add_room') }}">
        <h3>Aggiungi nuova stanza</h3>
        <button type="button" id="scan-btn">üîç Mostra ancore disponibili</button>
        <div id="scan-results"></div>
        <input type="text" name="room_name" placeholder="Nome stanza" required>
        <input type="text" name="mac_address" placeholder="MAC ancora BT" id="mac_address" required>
        <div>
          <label for="allowed-switch">Accesso stanza</label>
          <label class="switch">
            <input type="checkbox" id="allowed-switch" name="allowed" value="1" checked>
            <span class="slider"></span>
          </label>
        </div>
        <button type="submit">Salva</button>
      </form>

      <!-- Tabella stanze -->
      <h3>Stanze (ancore BLE)</h3>
      {% if rooms %}
      <table class="rooms-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>MAC</th>
            <th>Accessibile</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody>
          {% for room in rooms %}
          <tr>
            <td>{{ room['name']|capitalize }}</td>
            <td>{{ room.get('mac_address', '-') }}</td>
            <td>
              <form method="post" action="{{ url_for('toggle_room_access', room_id=room['_id']) }}">
                <label class="switch">
                  <input type="checkbox" name="allowed" value="1" onchange="this.form.submit()" {% if room.get('allowed') %}checked{% endif %}>
                  <span class="slider"></span>
                </label>
                {% if room.get('allowed') %}<span>S√¨</span>{% else %}<span>No</span>{% endif %}
              </form>
            </td>
            <td>
              <form method="post" action="{{ url_for('delete_room', room_id=room['_id']) }}">
                <button class="btn-ghost" title="Elimina stanza">üóëÔ∏è</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div>Nessuna stanza registrata.</div>
      {% endif %}
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --- Tutta la logica originale invariata ---
    let center = [
        {{ perimeter_center[0]|default(45.123456,true)|float }},
        {{ perimeter_center[1]|default(9.123456,true)|float }}
    ];
    let radius = {{ perimeter_radius|default(50,true)|int }};
    if (isNaN(center[0]) || isNaN(center[1])) center = [45.123456, 9.123456];
    if (isNaN(radius)) radius = 50;

    let map = L.map('map').setView(center, 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { minZoom: 2, maxZoom: 20 }).addTo(map);
    let circle = L.circle(center, { radius: radius, color: '#3949ab', fillColor: '#b3d4fc', fillOpacity: 0.28 }).addTo(map);

    let selectedPetId = null;

    function selectPetRow(tr) {
      document.querySelectorAll('#pets-table tbody tr').forEach(r => r.classList.remove('pet-selected'));
      if (!tr) return;
      tr.classList.add('pet-selected');
      selectedPetId = tr.dataset.petId || null;
    }

    function setCenterToPetLocation(petIdArg) {
      const petId = petIdArg || selectedPetId;
      if (!petId) return alert('Seleziona un pet nella tabella o usa il pulsante accanto.');
      fetch('/get_pet_location/' + encodeURIComponent(petId))
        .then(r => r.json())
        .then(data => {
          if (data && data.gps && data.gps.lat !== undefined) {
            const lat = parseFloat(data.gps.lat);
            const lon = parseFloat(data.gps.lon);
            circle.setLatLng([lat, lon]);
            map.setView([lat, lon], 18);
            document.getElementById('center_lat').value = lat.toFixed(7);
            document.getElementById('center_lng').value = lon.toFixed(7);
          } else alert('Nessuna posizione GPS disponibile.');
        })
        .catch(() => alert('Impossibile recuperare la posizione del pet'));
    }

    document.getElementById('radius_slider').addEventListener('input', function() {
      let val = parseInt(this.value);
      circle.setRadius(val);
      document.getElementById('radius_label').textContent = val + ' m';
    });

    map.on('click', function(e) {
      circle.setLatLng(e.latlng);
      document.getElementById('center_lat').value = e.latlng.lat.toFixed(7);
      document.getElementById('center_lng').value = e.latlng.lng.toFixed(7);
    });

    document.getElementById('scan-btn').onclick = function() {
      let resultsDiv = document.getElementById('scan-results');
      resultsDiv.innerHTML = 'Caricamento...';
      fetch('/anchors_online')
        .then(r => r.json())
        .then(data => {
          resultsDiv.innerHTML = '';
          if (data.anchors && data.anchors.length) {
            data.anchors.forEach(anchor => {
              let btn = document.createElement('button');
              btn.className = 'btn-ghost';
              btn.textContent = anchor.anchor_id + " ‚Äî " + anchor.mac_address;
              btn.onclick = () => { document.getElementById('mac_address').value = anchor.mac_address; };
              resultsDiv.appendChild(btn);
            });
          } else resultsDiv.innerHTML = "<small>Nessuna ancora trovata.</small>";
        });
    };

    {% if pet_position %}
      const initialPetPos = [{{ pet_position[0] }}, {{ pet_position[1] }}];
      L.marker(initialPetPos).addTo(map).bindPopup("Ultima posizione globale").openPopup();
    {% endif %}

    document.querySelectorAll('#pets-table tbody tr[data-pet-id]').forEach(tr => {
      tr.addEventListener('click', () => selectPetRow(tr));
    });
  </script>
</body>
</html>
