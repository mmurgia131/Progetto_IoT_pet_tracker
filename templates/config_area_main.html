<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Stanze e Area</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
      body { background: #fafafa; }
      .container { max-width: 1100px; margin: 40px auto; background: #fff; padding: 32px; border-radius: 18px; box-shadow: 0 0 16px #e2e8f0; }
      h1 { font-size: 2.1rem; color: #1a237e; margin-bottom: 28px; font-weight: 600;}
      hr { margin: 34px 0 26px 0; }

      /* Bottone Torna alla Dashboard */
      .dashboard-btn-container {
          margin: 16px 0 32px 10px;
      }
      .dashboard-btn {
          background: #1976d2;
          color: #fff;
          border: none;
          border-radius: 8px;
          padding: 12px 24px;
          font-size: 1.25rem;
          font-family: inherit;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(25,118,210,0.13);
          transition: background 0.2s;
          font-weight: 500;
          display: flex;
          align-items: center;
      }
      .dashboard-btn:hover { background: #125a9c; }

      /* Mappa e perimetro */
      #map { height: 320px; border-radius: 14px; border: 1.5px solid #b3d4fc; margin-bottom: 15px; margin-top: 8px; width: 100%; }
      .radius-config { display: flex; align-items: center; gap: 18px; margin-bottom: 24px; }
      .radius-badge { background: #3949ab; color: #fff; border-radius: 12px; padding: 3px 13px; font-size: 1.04rem; font-weight: 500; }
      .use-gps-btn {
          margin-left: 18px;
          background: #43a047;
          color: #fff;
          border: none;
          border-radius: 8px;
          padding: 6px 22px;
          font-size: 1.08rem;
          cursor: pointer;
          font-weight: 600;
          transition: background 0.15s;
      }
      .use-gps-btn:hover { background: #308030; }

      /* Form aggiungi stanza */
      .add-room-form {
        background: #fff;
        border-radius: 24px;
        box-shadow: 0 2px 18px #e2eaf3;
        padding: 40px 28px 30px 28px;
        max-width: 900px;
        margin: 38px auto 40px auto;
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }
      .add-room-form h3 {
        color: #20307d;
        font-size: 1.35rem;
        font-weight: 800;
        margin-bottom: 22px;
      }
      .scan-section { margin-bottom: 18px; width: 100%; }
      #scan-btn {
        background: #1976d2;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 18px 0;
        font-size: 1.16rem;
        font-weight: 500;
        width: 100%;
        transition: background 0.13s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }
      #scan-btn:hover { background: #125a9c; }
      #scan-results { margin-bottom: 12px; display: none; background: #f3f7fb; padding: 10px; border-radius: 6px; max-height: 170px; overflow-y: auto; font-size: 1.03rem;}
      .add-room-form input[type="text"] {
        margin-bottom: 15px;
        border: 1px solid #c3c3c3;
        border-radius: 7px;
        padding: 13px 18px;
        font-size: 1.13rem;
        width: 100%;
        box-sizing: border-box;
        background: #fafdff;
      }
      .restriction-section {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 22px;
        font-weight: 600;
      }
      .restriction-label {
        font-size: 1.08rem;
        color: #242424;
        font-weight: 600;
        margin-right: 0;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
        vertical-align: middle;
      }
      .switch input { opacity: 0; width: 0; height: 0;}
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #e0e0e0;
        transition: .35s;
        border-radius: 22px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .35s;
        border-radius: 50%;
        box-shadow: 0 1px 2px #aaa;
      }
      .switch input:checked + .slider { background-color: #43a047; }
      .switch input:checked + .slider:before { transform: translateX(20px); }
      .add-room-form button[type="submit"] {
        background: #388e3c;
        color: #fff;
        border: none;
        padding: 16px 0;
        border-radius: 11px;
        font-size: 1.22rem;
        width: 100%;
        font-weight: 700;
        margin-top: 6px;
        margin-bottom: 9px;
        transition: background 0.16s;
      }
      .add-room-form button[type="submit"]:hover { background: #256924; }

      /* --- Nuovo stile tabella stanze --- */
      .rooms-table.clean-look {
        border-collapse: collapse;
        width: 100%;
        background: #fff;
        margin: 0;
      }
      .rooms-table.clean-look th {
        background: #f5f8fa;
        color: #1a237e;
        font-weight: 700;
        border-bottom: 2px solid #e0e0e0;
        font-size: 1.09rem;
        padding: 13px 16px;
        text-align: left;
      }
      .rooms-table.clean-look td {
        border-bottom: 1px solid #f1f1f1;
        font-size: 1.07rem;
        padding: 15px 16px;
        background: none;
        vertical-align: middle;
      }
      .rooms-table.clean-look tr:last-child td {
        border-bottom: none;
      }
      .room-access-state {
        font-weight: 700;
        font-size: 1.01rem;
        padding: 4px 12px;
        border-radius: 10px;
        background: #e2f8ea;
        color: #22884f;
        margin-left: 9px;
      }
      .room-access-state.no {
        background: #ffe6e6;
        color: #d32f2f;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 38px;
        height: 22px;
        vertical-align: middle;
        margin-right: 0;
      }
      .switch input { opacity: 0; width: 0; height: 0;}
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #e0e0e0;
        transition: .35s;
        border-radius: 22px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .35s;
        border-radius: 50%;
        box-shadow: 0 1px 2px #aaa;
      }
      .switch input:checked + .slider { background-color: #43a047; }
      .switch input:checked + .slider:before { transform: translateX(16px); }
      .delete-btn svg { vertical-align: middle; }
      .delete-btn:hover svg { stroke: #fff; background: #d32f2f; border-radius: 50%; }
      .delete-btn {
        background:none;
        border:none;
        padding:0 7px;
        cursor:pointer;
      }
      @media (max-width: 900px) {
        .container { max-width: 98vw;}
        .add-room-form { max-width: 100vw; }
        .rooms-table.clean-look th, .rooms-table.clean-look td {font-size: 0.96rem; padding: 8px 4px;}
      }
  </style>
</head>
<body>

  <!-- Bottone Torna alla Dashboard -->
  <div class="dashboard-btn-container">
      <form method="get" action="{{ url_for('dashboard') }}" style="display: inline;">
          <button type="submit" class="dashboard-btn">&#8592; Torna alla Dashboard</button>
      </form>
  </div>

  <div class="container">
      <h1>Gestione Stanze e Area Consentita</h1>

      <!-- Mappa perimetro -->
      <div class="perimeter-section">
        <h3>Area consentita</h3>
        <div id="map"></div>
        <form id="perimeter-form" method="post" action="{{ url_for('update_perimeter') }}" class="radius-config">
          <span>Raggio:</span>
          <input type="range" id="radius_slider" name="radius" min="10" max="150" value="{{ perimeter_radius|default(50,true)|int }}">
          <span id="radius_label" class="radius-badge">{{ perimeter_radius|default(50,true)|int }} m</span>
          <input type="hidden" name="center_lat" id="center_lat" value="{{ perimeter_center[0]|default(45.123456,true)|float }}">
          <input type="hidden" name="center_lng" id="center_lng" value="{{ perimeter_center[1]|default(9.123456,true)|float }}">
          <button type="button" class="use-gps-btn" onclick="setCenterToPetLocation()">Usa posizione attuale del Pet</button>
          <button type="submit" class="btn btn-success btn-sm ms-3" style="margin-left:18px;">Salva perimetro</button>
        </form>
      </div>

      <!-- FORM AGGIUNGI STANZA -->
      <form class="add-room-form" method="post" action="{{ url_for('add_room') }}">
        <h3>Aggiungi nuova stanza</h3>
        <div class="scan-section">
          <button type="button" id="scan-btn">
            <span style="font-size:1.15em;">üîç</span> Scansiona ancore BT
          </button>
          <div id="scan-results"></div>
        </div>
        <input type="text" name="room_name" placeholder="Nome stanza" required>
        <input type="text" name="mac_address" placeholder="MAC ancora BT" id="mac_address" required>
        <div class="restriction-section">
          <label class="restriction-label" for="allowed-switch" title="Specifica se il pet pu√≤ accedere in questa stanza">
            Accesso stanza
          </label>
          <label class="switch">
            <input type="checkbox" id="allowed-switch" name="allowed" value="1" checked>
            <span class="slider"></span>
          </label>
        </div>
        <button type="submit">Salva</button>
      </form>

      <!-- Tabella STANZE (ancore BT) - Nuovo stile -->
      <h2 style="font-size:1.30rem; color:#222; font-weight:700; margin-top:45px;">Stanze (ancore BT)</h2>
      {% if rooms %}
      <div class="rooms-table-container">
        <table class="rooms-table clean-look">
          <thead>
            <tr>
              <th>Nome</th>
              <th>MAC</th>
              <th>Accessibile</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for room in rooms %}
            <tr>
              <td>{{ room['name']|capitalize }}</td>
              <td>{{ room.get('mac_address', '-') }}</td>
              <td>
                <form method="post" action="{{ url_for('toggle_room_access', room_id=room['_id']) }}" style="display:inline;">
                  <label class="switch" title="Cambia accessibilit√†" style="vertical-align:middle;">
                    <input type="checkbox" name="allowed" value="1" onchange="this.form.submit()" {% if room.get('allowed') %}checked{% endif %}>
                    <span class="slider"></span>
                  </label>
                  <span class="room-access-state {% if not room.get('allowed') %}no{% endif %}">
                    {% if room.get('allowed') %}S√¨{% else %}No{% endif %}
                  </span>
                </form>
              </td>
              <td>
                <form method="post" action="{{ url_for('delete_room', room_id=room['_id']) }}" style="display:inline;">
                  <button class="delete-btn" title="Elimina stanza">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                      stroke="#d32f2f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"/>
                      <path d="M19 6V19a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                    </svg>
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div>Nessuna stanza registrata.</div>
      {% endif %}
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // MAPPA INTERATTIVA PERIMETRO
    let center = [
        {{ perimeter_center[0]|default(45.123456,true)|float }},
        {{ perimeter_center[1]|default(9.123456,true)|float }}
    ];
    let radius = {{ perimeter_radius|default(50,true)|int }};
    if (isNaN(center[0]) || isNaN(center[1])) center = [45.123456, 9.123456];
    if (isNaN(radius)) radius = 50;
    let map = L.map('map').setView(center, 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        minZoom: 2, maxZoom: 20
    }).addTo(map);

    let circle = L.circle(center, {
        radius: radius,
        color: '#3949ab',
        fillColor: '#b3d4fc',
        fillOpacity: 0.28
    }).addTo(map);

    // --- PET MARKER ---
    {% if pet_position %}
    let petPos = [{{ pet_position[0] }}, {{ pet_position[1] }}];
    let petMarker = L.marker(petPos, {title: "Posizione attuale del Pet"}).addTo(map);
    petMarker.bindPopup("Pet attuale").openPopup();
    {% endif %}

    // Click per spostare il centro
    map.on('click', function(e) {
        circle.setLatLng(e.latlng);
        document.getElementById('center_lat').value = e.latlng.lat.toFixed(7);
        document.getElementById('center_lng').value = e.latlng.lng.toFixed(7);
    });

    // Slider per cambiare raggio
    document.getElementById('radius_slider').addEventListener('input', function(e) {
        let val = parseInt(this.value);
        circle.setRadius(val);
        document.getElementById('radius_label').textContent = val + ' m';
    });

    // --- Bottone "Usa posizione attuale del Pet" ---
    function setCenterToPetLocation() {
      fetch('/get_latest_gps')
        .then(r => r.json())
        .then(gps => {
          if (gps && gps.lat && gps.lon) {
            circle.setLatLng([gps.lat, gps.lon]);
            map.setView([gps.lat, gps.lon], 18);
            document.getElementById('center_lat').value = gps.lat.toFixed(7);
            document.getElementById('center_lng').value = gps.lon.toFixed(7);
          }
        });
    }

    // --- WebSocket BLE Scan ---
    let ws;
    function ensureWS() {
        if (ws && (ws.readyState === 1 || ws.readyState === 0)) return;
        let resultsDiv = document.getElementById('scan-results');
        document.getElementById('scan-results').style.display = 'block';
        resultsDiv.innerHTML = "Connessione al server BLE...";
        ws = new WebSocket("ws://localhost:8765/");
        ws.onopen = () => {
            resultsDiv.innerHTML = "Connesso. Premi di nuovo per scansionare.";
        };
        ws.onclose = () => {
            resultsDiv.innerHTML = "Connessione WebSocket chiusa";
        };
        ws.onerror = () => {
            resultsDiv.innerHTML = "Errore WebSocket";
        };
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.type === "ble_scan_result" && data.devices) {
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = '';
                    const devices = data.devices || [];
                    if (devices.length === 0) {
                        resultsDiv.innerHTML = 'Nessun dispositivo trovato.';
                        return;
                    }
                    devices.forEach(dev => {
                        let div = document.createElement('div');
                        div.className = 'device-item';
                        div.textContent = (dev.name || '(Sconosciuto)') + ' ‚Äî ' + dev.mac;
                        div.onclick = function() {
                            document.getElementById('mac_address').value = dev.mac;
                        };
                        resultsDiv.appendChild(div);
                    });
                }
            } catch (e) {
                resultsDiv.innerHTML = "Errore dati BLE";
            }
        };
    }

    document.getElementById('scan-btn').onclick = function() {
        let resultsDiv = document.getElementById('scan-results');
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = 'Scansione in corso...';

        ensureWS();

        setTimeout(() => {
            if (ws && ws.readyState === 1) {
                ws.send(JSON.stringify({ type: "scan_ble" }));
            } else if (ws && ws.readyState === 0) {
                resultsDiv.innerHTML = "Attendere connessione WebSocket...";
            } else {
                resultsDiv.innerHTML = "WebSocket non connesso";
            }
        }, 300);
    };

    // --- Accesso consentito: forza valore submit (0/1) ---
    document.querySelector('.add-room-form').addEventListener('submit', function(e) {
      let allowedSwitch = document.getElementById('allowed-switch');
      if (!allowedSwitch.checked) {
        allowedSwitch.value = "0";
        let hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'allowed';
        hidden.value = '0';
        this.appendChild(hidden);
        allowedSwitch.disabled = true;
      } else {
        allowedSwitch.value = "1";
      }
    });
  </script>
</body>
</html>