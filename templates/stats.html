<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Pet Movement Statistics</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
:root{
  --zoom: 1;
}
body{ background:#f6f7fb; color:#222; }
.container{ max-width:1100px; margin:24px auto; background:#fff; padding:28px; border-radius:14px; box-shadow:0 8px 26px rgba(0,0,0,.06); }
h1{ margin:0 0 18px; font-size:28px; }
.badges{ display:flex; gap:14px; flex-wrap:wrap; margin:10px 0 18px; }
.badge{ background:#f4f6fa; padding:10px 14px; border-radius:10px; font-weight:600; }
.legend{ display:flex; align-items:center; gap:18px; margin:6px 0 18px; flex-wrap:wrap; }
.legend span{ display:flex; align-items:center; gap:8px; }
.legend i{ display:inline-block; width:14px; height:14px; border-radius:3px; }
.leg-green{ background:#49c24b; }     /* Interna Consentita (BLE)   */
.leg-red{ background:#e65c5c; }       /* Interna NON Consentita     */
.leg-azzurro{ background:#53c7c3; }   /* Esterna Consentita (GPS)   */
.leg-orange{ background:#ffa500; }    /* Esterna NON Consentita     */
.leg-gray{ background:#e9ecef; border:1px solid #dcdfe5; } /* Nessun dato */

.controls{ display:flex; gap:18px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
.controls select, .controls input[type=date]{ padding:8px 10px; border-radius:8px; border:1px solid #d7dbe5; background:#fff; }
.controls .zoom{ margin-left:auto; display:flex; align-items:center; gap:10px; }
.controls input[type=range]{ width:260px; }

.card{ border:1px solid #eef0f4; border-radius:12px; padding:16px; }
.card h3{ margin:0 0 10px; font-size:18px; }

.timeline-wrap{ margin-top:8px; }
.viewport{ position:relative; overflow-x:auto; border:1px solid #eef0f4; border-radius:10px; background:#fff; }
.inner{ position:relative; width:calc(100% * var(--zoom)); padding:16px 14px; }

.grid.hours{
  position:absolute; inset:0;
  background-image: repeating-linear-gradient(to right, rgba(0,0,0,.06) 0, rgba(0,0,0,.06) 1px, transparent 1px, transparent calc(100%/24));
  pointer-events:none;
}
.grid.minutes{
  position:absolute; inset:0; opacity:.7; display:none;
  background-image: repeating-linear-gradient(to right, rgba(0,0,0,.04) 0, rgba(0,0,0,.04) 1px, transparent 1px, transparent calc(100%/96)); /* ogni 15' */
  pointer-events:none;
}
.inner.show-minutes .grid.minutes{ display:block; }

.row{ position:relative; margin:26px 0 18px; padding-top:18px; }
.row .daylabel{ position:absolute; top:-10px; left:12px; font-weight:700; background:#fff; padding:2px 6px; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,.05); }
.bar{ display:flex; height:26px; border-radius:7px; overflow:hidden; background:#fafbfe; border:1px solid #eef0f4; }
.seg{ height:100%; }
.seg[data-title]{ position:relative; }
.seg[data-title]:hover::after{
  content: attr(data-title) " (" attr(data-start) "â€“" attr(data-end) ")";
  position:absolute; top:-36px; left:0;
  background:#111; color:#fff; font-size:12px; white-space:nowrap;
  padding:6px 8px; border-radius:6px; transform:translateY(-6px);
}

.ticks{ position:relative; margin-top:10px; color:#6b7280; font-size:12px; }
.ticks .scale{ position:relative; width:calc(100% * var(--zoom)); height:18px; }
.ticks .scale > span{
  position:absolute; top:0; transform:translateX(-50%); white-space:nowrap;
}
.dashboard-btn-container {
  margin: 16px 0 32px 10px;
}
.dashboard-btn {
  background: #1976d2;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 12px 24px;
  font-size: 1.25rem;
  font-family: inherit;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(25,118,210,0.13);
  transition: background 0.2s;
  font-weight: 500;
  display: flex;
  align-items: center;
}
.dashboard-btn:hover { background: #125a9c; }
</style>
</head>
<body>
<div class="dashboard-btn-container">
  <button type="button" class="dashboard-btn" onclick="history.back(); return false;">&#8592; Torna indietro</button>
</div>
<div class="container">

  <h1>Pet Movement Statistics</h1>

  <div class="controls">
    <div>
      <label>Periodo:</label>
      <select id="period" name="period" onchange="applyFilters()">
        <option value="day"   {{ 'selected' if period=='day'   else '' }}>Giorno</option>
        <option value="week"  {{ 'selected' if period=='week'  else '' }}>Settimana</option>
        <option value="month" {{ 'selected' if period=='month' else '' }}>Mese</option>
      </select>
    </div>
    <div>
      <label>Data:</label>
      <input id="date" type="date" value="{{ current_date_iso }}" onchange="applyFilters()">
    </div>

    <div class="zoom">
      <label>Zoom:</label>
      <input id="zoomRange" type="range" min="1" max="8" step="0.5" value="1">
    </div>
  </div>

  <div class="badges">
    <div class="badge">Total Movements: {{ stats.n_points }}</div>
    <div class="badge">Top Room: {{ stats.top_room }}</div>
    <div class="badge">Last Movement: {{ stats.last_movement }}</div>
    <div class="badge">Restricted Entries: {{ stats.restricted_entries }}</div>
  </div>

  <div class="legend">
    <span><i class="leg-green"></i> Zona Interna Consentita</span>
    <span><i class="leg-red"></i> Zona Interna NON Consentita</span>
    <span><i class="leg-azzurro"></i> Zona Esterna Consentita</span>
    <span><i class="leg-orange"></i> Zona Esterna NON Consentita</span>
    <span><i class="leg-gray"></i> Nessun dato</span>
  </div>

  <div class="card timeline-wrap">
    <h3>Timeline</h3>
    <div class="viewport" id="viewport">
      <div class="inner" id="inner">
        <div class="grid hours"></div>
        <div class="grid minutes"></div>

        {% for day, segs in timeline_by_day.items() %}
          <div class="row">
            <div class="daylabel">{{ day }}</div>
            <div class="bar">
              {% for s in segs %}
                <span class="seg"
                      style="width: {{ '%.6f'|format(s.width_pct) }}%; background: {{ s.colore }};"
                      data-title="{{ s.label }}" data-start="{{ s.start }}" data-end="{{ s.end }}">
                </span>
              {% endfor %}
            </div>
          </div>
        {% endfor %}

        <div class="ticks">
          <div class="scale" id="tickScale">
            {% for h in calendar_hours %}
              <span style="left: calc({{ loop.index0 }}/24 * 100%);">{{ h }}</span>
            {% endfor %}
          </div>
        </div>

      </div>
    </div>
  </div>

</div>

<script>
function applyFilters(){
  const period = document.getElementById('period').value;
  const date   = document.getElementById('date').value;
  const url = new URL(window.location.href);
  url.searchParams.set('period', period);
  if(date) url.searchParams.set('date', date);
  window.location.href = url.toString();
}

const range = document.getElementById('zoomRange');
const inner = document.getElementById('inner');

function setZoom(z){
  document.documentElement.style.setProperty('--zoom', z);
  // mostra le tacche dei minuti quando zoom >= 3x
  if(z >= 3){
    inner.classList.add('show-minutes');
    // aggiungo etichette 15' se non ci sono
    ensureQuarterTickLabels(z);
  }else{
    inner.classList.remove('show-minutes');
    resetHourTickLabels();
  }
}
range.addEventListener('input', e => setZoom(parseFloat(e.target.value)));
setZoom(parseFloat(range.value));

function resetHourTickLabels(){
  const sc = document.getElementById('tickScale');
  sc.innerHTML = '';
  for(let i=0;i<=24;i++){
    const sp = document.createElement('span');
    sp.style.left = `calc(${i}/24 * 100%)`;
    sp.textContent = String(i).padStart(2,'0');
    sc.appendChild(sp);
  }
}

function ensureQuarterTickLabels(z){
  // Tacche ogni 15 minuti
  const sc = document.getElementById('tickScale');
  sc.innerHTML = '';
  for(let h=0; h<24; h++){
    for(let q=0; q<4; q++){
      const pos = (h*4 + q) / 96 * 100; // 96 = 24*4
      const sp = document.createElement('span');
      sp.style.left = `calc(${pos}% )`;
      sp.textContent = q===0 ? String(h).padStart(2,'0')+':00' : `:${String(q*15).padStart(2,'0')}`;
      sc.appendChild(sp);
    }
  }
}
const dateEl = document.getElementById('date');
  dateEl.addEventListener('change', applyFilters);
  dateEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') applyFilters();
  });
</script>
</body>
</html>