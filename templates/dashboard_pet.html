<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dashboard di {{ pet.name }}</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: #f5f5f5;
      color: #222;
    }

    .dashboard-btn-container {
      margin: 16px 0 32px 10px;
    }

    .dashboard-btn {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 1.25rem;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(25,118,210,0.13);
      transition: background 0.2s;
      font-weight: 500;
      display: flex;
      align-items: center;
    }

    .dashboard-btn:hover {
      background: #125a9c;
    }

    .header-centered {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 28px 0 22px 0;
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 0;
    }

    .title-centered {
      font-size: 2.1rem;
      font-weight: 700;
      color: #1976d2;
      margin: 0;
      text-align: center;
    }

    .main {
      padding: 44px 5vw 60px 5vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #f5f5f5;
      min-height: 100vh;
    }

    #env-box {
      margin: 22px 0 12px 0;
      padding: 18px 30px;
      background: #e3f1fe;
      border-radius: 14px;
      display: inline-block;
      font-size: 1.13rem;
      font-weight: 500;
      color: #1a237e;
      box-shadow: 0 2px 6px #e2eaf3;
      min-width: 210px;
      text-align: center;
    }

    #env-temp,
    #env-hum {
      font-weight: 700;
      color: #0d47a1;
    }

    #loc-box {
      margin-top: 10px;
      padding: 10px 18px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.04);
      font-size: 1.03rem;
      color: #333;
      display: inline-block;
    }

    #loc-box a {
      color: #1976d2;
      text-decoration: underline;
      font-weight: 600;
    }

    .big-actions {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 18px;
      width: 100%;
      max-width: 520px;
      align-items: center;
    }

    .big-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 66%;
      min-width: 260px;
      text-decoration: none;
      background: linear-gradient(180deg, #1976d2, #145a9b);
      color: #fff;
      padding: 14px 22px;
      border-radius: 12px;
      font-size: 1.08rem;
      font-weight: 700;
      box-shadow: 0 8px 20px rgba(25,118,210,0.12);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      border: none;
    }

    .big-btn.secondary {
      background: linear-gradient(180deg, #e3f2fd, #cfe9fd);
      color: #1976d2;
      box-shadow: 0 6px 16px rgba(16,64,122,0.06);
      border: 1px solid #cfe9fd;
      font-weight: 700;
    }

    .big-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(25,118,210,0.16);
    }

    .big-btn.secondary:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 26px rgba(12,62,107,0.07);
    }

    .threshold-form {
      margin-top: 28px;
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .threshold-row {
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    @media (max-width: 900px) {
      .big-btn {
        width: 90%;
        min-width: 0;
      }
      .big-actions {
        max-width: 360px;
      }
      .main {
        padding: 22px 4vw 44px 4vw;
      }
      .title-centered {
        font-size: 1.6rem;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-btn-container">
    <form method="get" action="{{ url_for('dashboard') }}" style="display: inline;">
      <button type="submit" class="dashboard-btn">&#8592; Torna alla Dashboard</button>
    </form>
  </div>

  <div class="header-centered">
    <h1 class="title-centered">Dashboard di {{ pet.name }}</h1>
  </div>

  <div class="main">
    <div id="env-box">
      <strong>Ambiente:</strong>
      <span id="env-temp">--</span>Â°C,
      <span id="env-hum">--</span>%
    </div>

    <div id="loc-box">
      Posizione: <span id="loc-text">--</span>
    </div>

    <div class="big-actions">
      <a class="big-btn" href="{{ url_for('camera') }}">ðŸ“· Telecamera</a>
      <a class="big-btn secondary" href="{{ url_for('stats', pet_id=pet._id) }}">ðŸ“Š Statistiche</a>
    </div>

    <div class="threshold-form">
      <form method="post" action="{{ url_for('update_temp_thresholds', pet_id=pet._id) }}">
        <div class="threshold-row">
          <label for="temp_min"><b>Soglia minima (Â°C):</b></label>
          <input type="number" step="0.1" name="temp_min" id="temp_min"
                 value="{{ pet.temp_min if pet.temp_min is not none else '' }}" style="width:90px;">
          <label for="temp_max"><b>Soglia massima (Â°C):</b></label>
          <input type="number" step="0.1" name="temp_max" id="temp_max"
                 value="{{ pet.temp_max if pet.temp_max is not none else '' }}" style="width:90px;">
        </div>
        <div style="margin-top:12px;">
          <button type="submit" class="dashboard-btn" style="padding:10px 28px; font-size:1rem;">Salva soglie</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const PET_ID = "{{ pet._id }}";
    const PET_MAC = "{{ pet.get('mac_address','') }}";
    const STALE_SEC = 3 * 60; // 3 minuti

    let lastGpsTs = null;
    let currentGps = null;
    let lastRoomTs = null;
    let currentRoom = null;

    function epochNow() { return Math.floor(Date.now() / 1000); }

    function renderGPS(lat, lon, ts) {
      currentGps = { lat: parseFloat(lat), lon: parseFloat(lon) };
      lastGpsTs = ts || epochNow();
      const span = document.getElementById('loc-text');
      const latS = currentGps.lat.toFixed(6);
      const lonS = currentGps.lon.toFixed(6);
      const mapUrl = "{{ url_for('localizza') }}" + `?lat=${encodeURIComponent(latS)}&lon=${encodeURIComponent(lonS)}&mac=${encodeURIComponent(PET_MAC)}`;
      span.innerHTML = `GPS: (${latS}, ${lonS}) â€” Vai alla <a href="${mapUrl}">mappa</a>`;
    }

    function renderRoom(roomName, ts) {
      currentRoom = roomName;
      lastRoomTs = ts || epochNow();
      document.getElementById('loc-text').textContent = `Stanza: ${roomName}`;
    }

    function clearLocation() {
      currentGps = null;
      currentRoom = null;
      document.getElementById('loc-text').textContent = 'Nessuna posizione disponibile';
    }

    // === Aggiornamento ENV via API (fallback) ===
    function updateEnvBox() {
      fetch(`/get_latest_env/${PET_ID}`)
        .then(r => r.json())
        .then(env => {
          if (!env) return;
          document.getElementById('env-temp').textContent =
            (env.temp !== null && !isNaN(env.temp)) ? parseFloat(env.temp).toFixed(1) : '--';
          document.getElementById('env-hum').textContent =
            (env.hum !== null && !isNaN(env.hum)) ? parseFloat(env.hum).toFixed(1) : '--';
        })
        .catch(console.error);
    }

    function updateLocationBox() {
      fetch(`/get_pet_location/${PET_ID}`)
        .then(r => r.json())
        .then(data => {
          const now = epochNow();
          if (data.room && data.room_last_seen && (now - data.room_last_seen) < STALE_SEC) {
            renderRoom(data.room, data.room_last_seen);
          } else if (data.gps && data.gps_last_seen && (now - data.gps_last_seen) < STALE_SEC) {
            if (!lastRoomTs || (now - lastRoomTs) > STALE_SEC) renderGPS(data.gps.lat, data.gps.lon, data.gps_last_seen);
          } else {
            clearLocation();
          }
        })
        .catch(() => clearLocation());
    }

    // === WebSocket realtime ===
    (function initWS() {
      const wsScheme = location.protocol === "https:" ? "wss" : "ws";
      const wsUrl = wsScheme + "://" + location.hostname + ":8765/";
      let ws;

      try {
        ws = new WebSocket(wsUrl);
      } catch (e) {
        console.warn("WS non disponibile:", e);
        return;
      }

      ws.onopen = () => console.log("WS connesso (dashboard_pet)");
      ws.onclose = () => {
        console.log("WS chiuso (dashboard_pet) - riprovo in 5s");
        setTimeout(initWS, 5000);
      };
      ws.onerror = (e) => {
        console.warn("WS error:", e);
        try { ws.close(); } catch(e) {}
      };

      ws.onmessage = (evt) => {
        let msg = null;
        try { msg = JSON.parse(evt.data); } catch (e) { return; }
        if (!msg || !msg.type) return;

        const now = epochNow();

        // === BLE update (prioritÃ  massima) ===
        if (msg.type === "ble_update" || msg.type === "position_update") {
          const petMac = msg.pet_mac || null;
          const room = msg.room || msg.anchor || null;
          if (petMac && petMac === PET_MAC && room) {
            renderRoom(room, now);
            console.log(`[WS] Posizione BLE aggiornata: ${room}`);
          }
          return; // ignora GPS se arriva nello stesso frame
        }

        // === GPS update (solo se non ho BLE recente) ===
        if (msg.type === "gps_update") {
          const petMac = msg.pet_mac || null;
          const lat = parseFloat(msg.lat);
          const lon = parseFloat(msg.lon);
          if (petMac && petMac === PET_MAC) {
            if (lastRoomTs && (now - lastRoomTs) <= STALE_SEC) {
              console.log("[WS] Ignoro GPS perchÃ© BLE recente");
              return;
            }
            if (!isNaN(lat) && !isNaN(lon)) renderGPS(lat, lon, now);
          }
        }

        // === ENV update (temperatura/umiditÃ ) ===
        if (msg.type === "env_update" && msg.pet_mac === PET_MAC) {
          const t = parseFloat(msg.temp);
          const h = parseFloat(msg.hum);
          if (!isNaN(t)) document.getElementById('env-temp').textContent = t.toFixed(1);
          if (!isNaN(h)) document.getElementById('env-hum').textContent = h.toFixed(1);
        }
      };
    })();

    // === Init e polling periodico ===
    updateEnvBox();
    updateLocationBox();
    setInterval(updateEnvBox, 20000);
    setInterval(updateLocationBox, 10000);
  </script>
</body>
</html>
